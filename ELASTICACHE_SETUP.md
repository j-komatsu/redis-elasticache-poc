# AWS ElastiCache for Redis OSS 作成手順（完全ガイド）

このガイドでは、AWS ElastiCache for Redis OSSを**クラスターキャッシュ（独自設計）**で作成する手順を詳しく解説します。

## 目次

1. [事前準備](#1-事前準備)
2. [VPCとサブネットの確認](#2-vpcとサブネットの確認)
3. [サブネットグループの作成](#3-サブネットグループの作成)
4. [セキュリティグループの作成](#4-セキュリティグループの作成)
5. [ElastiCacheクラスターの作成](#5-elasticacheクラスターの作成)
6. [接続情報の確認](#6-接続情報の確認)
7. [トラブルシューティング](#7-トラブルシューティング)

---

## 1. 事前準備

### 必要な情報を整理

- **リージョン**: ap-northeast-1（東京）
- **VPC**: 既存のVPCを使用 または 新規作成
- **用途**: PoC（概念実証）/ 開発環境
- **予算**: 時間課金を理解した上で開始

### コスト見積もり

| インスタンスタイプ | 料金/時間 | 料金/日 | 料金/月 |
|------------------|----------|---------|---------|
| cache.t4g.micro | $0.018 | 約65円 | 約2,000円 |
| cache.t3.micro | $0.028 | 約100円 | 約3,000円 |

**重要**: 使い終わったら必ず削除してください！

---

## 2. VPCとサブネットの確認

### 手順

1. **AWSマネジメントコンソール**にログイン
2. **VPC**サービスに移動
3. 使用するVPCを確認または作成

### 必要な構成

```
VPC (例: 10.0.0.0/16)
├── パブリックサブネット (10.0.1.0/24) - AZ: ap-northeast-1a
│   └─ 用途: ELB, Bastion
├── パブリックサブネット (10.0.2.0/24) - AZ: ap-northeast-1c
├── プライベートサブネット (10.0.10.0/24) - AZ: ap-northeast-1a
│   └─ 用途: Beanstalk EC2, ElastiCache
└── プライベートサブネット (10.0.11.0/24) - AZ: ap-northeast-1c
    └─ 用途: ElastiCache（HA用）
```

### 確認ポイント

✅ **最低2つのAZ（アベイラビリティゾーン）**にサブネットがあること
✅ プライベートサブネットが存在すること
✅ VPC IDをメモ（例: `vpc-xxxxxxxxxxxxxxxxx`）

### パブリック/プライベートサブネットの見分け方

**重要**: ElastiCacheは**プライベートサブネット**にしか配置できません！

#### 確認手順

1. **VPCコンソール** > **サブネット** に移動
2. サブネットを選択
3. 下部の**「ルートテーブル」タブ**をクリック
4. ルート情報を確認:

**パブリックサブネット:**
```
送信先              ターゲット
─────────────────────────────
10.0.0.0/16        local
0.0.0.0/0          igw-xxxxx  ← インターネットゲートウェイ
```

**プライベートサブネット:**
```
送信先              ターゲット
─────────────────────────────
10.0.0.0/16        local
0.0.0.0/0          nat-xxxxx  ← NATゲートウェイ（または存在しない）
```

**判定基準:**
- ✅ `0.0.0.0/0` → `igw-xxxxx` = **パブリック**
- ✅ `0.0.0.0/0` → `nat-xxxxx` または なし = **プライベート**

---

## 2-A. プライベートサブネットがない場合の追加手順

**デフォルトVPC（`172.31.x.x`）を使っている場合、プライベートサブネットが存在しないことがあります。**

その場合は、以下の手順でプライベートサブネットを追加してください。

### ステップ1: プライベートサブネットを2つ作成

1. **VPCコンソール** > **サブネット** > **「サブネットを作成」**

2. **VPC を選択**:
   - 使用する既存のVPC（例: `vpc-xxxxxxxxxxxxxxxxx`）

3. **サブネット設定（1つ目）**:

   | 項目 | 値 |
   |------|-----|
   | **サブネット名** | `private-subnet-1a` |
   | **アベイラビリティゾーン** | `ap-northeast-1a` |
   | **IPv4 CIDR ブロック** | `172.31.100.0/24` |

4. **「新しいサブネットを追加」**をクリック

5. **サブネット設定（2つ目）**:

   | 項目 | 値 |
   |------|-----|
   | **サブネット名** | `private-subnet-1c` |
   | **アベイラビリティゾーン** | `ap-northeast-1c` |
   | **IPv4 CIDR ブロック** | `172.31.101.0/24` |

6. **「サブネットを作成」**をクリック

### ステップ2: プライベート用ルートテーブルを作成

1. **VPCコンソール** > **ルートテーブル** > **「ルートテーブルを作成」**

2. 設定:

   | 項目 | 値 |
   |------|-----|
   | **名前** | `private-route-table` |
   | **VPC** | 使用するVPC |

3. **「ルートテーブルを作成」**をクリック

4. 作成されたルートテーブルを選択

5. **「ルート」タブ**を確認:
   ```
   送信先              ターゲット
   ─────────────────────────────
   172.31.0.0/16      local  ← これだけでOK
   ```

   **重要**: `0.0.0.0/0` への経路（igw）は追加しないでください！

   **補足**: プライベートサブネットとパブリックサブネットの見分け方
   - **パブリックサブネット**: ルートテーブルに `0.0.0.0/0 → igw-xxxxx`（インターネットゲートウェイ）の経路がある
   - **プライベートサブネット**: ルートテーブルに `local` のみ、または `nat-xxxxx`（NATゲートウェイ）への経路のみ

### ステップ3: サブネットをルートテーブルに関連付け

1. `private-route-table` を選択

2. **「サブネットの関連付け」タブ** > **「サブネットの関連付けを編集」**

3. 作成した2つのサブネットを選択:
   - ✅ `private-subnet-1a`
   - ✅ `private-subnet-1c`

4. **「関連付けを保存」**をクリック

### ステップ4: 確認

1. **サブネット一覧**に戻る

2. `private-subnet-1a` を選択

3. **「ルートテーブル」タブ**をクリック

4. ルートを確認:
   ```
   送信先              ターゲット
   ─────────────────────────────
   172.31.0.0/16      local
   ```

   **✅ igw-xxxxx がないことを確認！**

これでプライベートサブネットの準備が完了です。

---

## 3. サブネットグループの作成

ElastiCacheはサブネットグループ内に配置されます。

### AWS Console での作成手順

1. **ElastiCache**コンソールに移動
   - サービス検索で「ElastiCache」と入力

2. 左メニューから**「サブネットグループ」**をクリック

3. **「サブネットグループを作成」**をクリック

4. 設定を入力:

   | 項目 | 値 | 説明 |
   |------|-----|------|
   | **名前** | `redis-poc-subnet-group` | 任意の名前 |
   | **説明** | `Redis PoC用サブネットグループ` | わかりやすい説明 |
   | **VPC** | 使用するVPCを選択 | 先ほど確認したVPC |

5. **サブネットを追加**:
   - ✅ ap-northeast-1a のプライベートサブネット
   - ✅ ap-northeast-1c のプライベートサブネット
   - **最低2つのAZ**を選択してください

6. **「作成」**をクリック

### AWS CLI での作成（オプション）

```bash
aws elasticache create-cache-subnet-group \
  --cache-subnet-group-name redis-poc-subnet-group \
  --cache-subnet-group-description "Redis PoC Subnet Group" \
  --subnet-ids subnet-xxxxx subnet-yyyyy \
  --region ap-northeast-1
```

---

## 4. セキュリティグループの作成

ElastiCache用のセキュリティグループを作成します。

### 手順

1. **EC2**コンソール > **セキュリティグループ**に移動

2. **「セキュリティグループを作成」**をクリック

3. 基本情報を入力:

   | 項目 | 値 |
   |------|-----|
   | **セキュリティグループ名** | `redis-poc-sg` |
   | **説明** | `ElastiCache Redis PoC Security Group` |
   | **VPC** | 使用するVPCを選択 |

4. **インバウンドルール**を追加:

   | タイプ | プロトコル | ポート範囲 | ソース | 説明 |
   |--------|-----------|-----------|--------|------|
   | カスタムTCP | TCP | 6379 | VPCのCIDR（例: `172.31.0.0/16`） | Allow from VPC |

   **推奨**: ソースには以下のいずれかを設定
   - **VPCのCIDR**: `172.31.0.0/16`（VPC内の全リソースから接続可能）
   - **BeanstalkのSG**: Beanstalk作成後にそのセキュリティグループID

   **⚠️ 注意**: `0.0.0.0/0` は警告が表示されるため、VPC CIDRの使用を推奨

5. **アウトバウンドルール**:
   - デフォルトのまま（全て許可）でOK

6. **「セキュリティグループを作成」**をクリック

7. **セキュリティグループIDをメモ**（例: `sg-xxxxxxxxxxxxxxxxx`）

### 後で更新するインバウンドルール（Beanstalk作成後）

```
タイプ: カスタムTCP
ポート: 6379
ソース: <Beanstalk EC2のセキュリティグループID>
説明: Allow from Beanstalk
```

---

## 5. ElastiCacheクラスターの作成

いよいよElastiCacheを作成します！

### 手順

1. **ElastiCacheコンソール**に移動

2. 左メニューから**「Redis OSS キャッシュ」**をクリック

3. **「Redisキャッシュを作成」**をクリック

### デプロイオプション

4. **デプロイオプションを選択**:

   ```
   ○ サーバーレスキャッシュを作成  ← 使わない
   ● クラスターキャッシュを作成    ← これを選択
   ```

### クラスター設定

5. **クラスター作成方法**:
   ```
   ● 新しいクラスターを作成
   ○ クラスターを復元
   ```

6. **クラスターモード**:
   ```
   ○ 有効  ← 複数のシャードを使用（本番向け）
   ● 無効  ← シンプル構成（PoC/開発向け） ← これを選択
   ```

7. **クラスター情報**:

   | 項目 | 値 | 説明 |
   |------|-----|------|
   | **名前** | `redis-poc-cluster` | 任意の名前（小文字・ハイフンのみ） |
   | **説明** | `Redis PoC Cluster` | わかりやすい説明 |
   | **エンジンバージョン** | `7.1` | 最新の安定版を推奨 |
   | **ポート** | `6379` | デフォルトのまま |
   | **パラメータグループ** | `default.redis7` | デフォルトでOK |

### ロケーション

8. **AWS クラウド**を選択（デフォルト）

### クラスター設定

9. **ノードタイプ**:
   - **「t4g」ファミリーを選択**（Graviton2プロセッサ - コスパ良い）
   - **`cache.t4g.micro`** を選択（推奨）
   - **`cache.t3.micro`** でもOK（AWS Consoleで t4g.micro が選択できない場合）
   - メモリ: 0.5 GiB（PoC用には十分）

   **注意**: AWS Consoleの画面によっては `cache.t4g.micro` が選択肢に表示されない場合があります。その場合は `cache.t3.micro` を選択してください。

10. **レプリカ数**:
    ```
    レプリカ数: 0  ← PoC用（本番なら1以上推奨）
    ```

    レプリカを追加する場合:
    ```
    レプリカ数: 1
    マルチAZ: 有効  ← 高可用性を確保
    ```

### サブネットグループ

11. **サブネットグループの設定**:
    - 先ほど作成した `redis-poc-subnet-group` を選択

### 可用性ゾーン配置

12. **可用性ゾーン**:
    ```
    ○ 指定なし  ← AWSが自動選択
    ● 可用性ゾーンを指定
      └─ プライマリ: ap-northeast-1a
      └─ レプリカ: ap-northeast-1c（レプリカありの場合）
    ```

### セキュリティ

13. **セキュリティグループ**:
    - 先ほど作成した `redis-poc-sg` を選択
    - デフォルトのセキュリティグループは削除

14. **暗号化**:

    | 設定 | 値 | 説明 |
    |------|-----|------|
    | **保管時の暗号化** | 無効 | PoC用なら不要 |
    | **転送時の暗号化** | 無効 | PoC用なら不要 |
    | **Redis AUTH** | 無効 | パスワード不要（VPC内保護） |

    **本番環境では暗号化を有効化してください！**

### バックアップ

15. **自動バックアップ**:
    ```
    ○ 自動バックアップを有効化  ← 本番用
    ● 自動バックアップを無効化  ← PoC用（コスト削減）
    ```

### メンテナンス

16. **メンテナンスウィンドウ**:
    ```
    ● ウィンドウを指定しない  ← AWSが自動選択
    ○ ウィンドウを指定する
    ```

### ログとタグ

17. **ログ**（オプション）:
    - スロークエリログ: 無効（PoC用）
    - エンジンログ: 無効（PoC用）

18. **タグ**（オプション）:
    - キー: `Environment` / 値: `PoC`
    - キー: `Project` / 値: `Redis-Demo`

### 確認と作成

19. **設定を確認**

20. **「作成」**をクリック

### 作成状況の確認

21. 作成には**約5〜10分**かかります

22. ステータスが **「使用可能」** になるまで待機

    ```
    ステータス:
    作成中 → 変更中 → 使用可能 ✅
    ```

---

## 6. 接続情報の確認

### プライマリエンドポイントの取得

1. ElastiCacheコンソールで作成したクラスターをクリック

2. **クラスターの詳細**画面で以下を確認:

   ```
   プライマリエンドポイント:
   redis-poc-cluster.xxxxx.ng.0001.apne1.cache.amazonaws.com:6379
   ```

3. **エンドポイントをコピー**（後で使用）

### 設定情報のまとめ

```yaml
ElastiCache 設定情報:
├─ クラスター名: redis-poc-cluster
├─ エンドポイント: redis-poc-cluster.xxxxx.ng.0001.apne1.cache.amazonaws.com
├─ ポート: 6379
├─ ノードタイプ: cache.t4g.micro
├─ エンジンバージョン: 7.1
└─ セキュリティグループ: redis-poc-sg
```

---

## 7. トラブルシューティング

### 作成が失敗する場合

#### エラー: サブネットグループが無効

**原因**: サブネットが2つのAZにまたがっていない

**解決策**:
```bash
# サブネットグループを削除して再作成
aws elasticache delete-cache-subnet-group --cache-subnet-group-name redis-poc-subnet-group
# 2つ以上のAZのサブネットを含めて再作成
```

#### エラー: セキュリティグループが見つからない

**原因**: VPCが異なる

**解決策**:
- セキュリティグループのVPCがElastiCacheと同じか確認
- 正しいVPCでセキュリティグループを作成し直す

### 接続できない場合

#### 症状: Connection timeout

**確認事項**:
1. ✅ セキュリティグループのインバウンドルールでポート6379が開いているか
2. ✅ アプリケーションとElastiCacheが同じVPC内にあるか
3. ✅ エンドポイントが正しいか（コピペミスに注意）
4. ✅ プライベートサブネット内からのアクセスか

**解決策**:
```bash
# EC2から接続テスト
sudo yum install -y redis
redis-cli -h redis-poc-cluster.xxxxx.cache.amazonaws.com -p 6379 ping
# 「PONG」が返ればOK
```

---

## 次のステップ

ElastiCacheの作成が完了したら:

1. ✅ **Elastic Beanstalk環境の作成** → [DEPLOY.md](DEPLOY.md) を参照
2. ✅ **セキュリティグループの更新** → BeanstalkのSGのみ許可
3. ✅ **アプリケーションのデプロイ**
4. ✅ **接続テスト**

---

## コスト管理

### 使用後の削除手順

1. ElastiCacheコンソールでクラスターを選択
2. **「削除」**をクリック
3. ✅ 「最終バックアップを作成しない」を選択（PoC用）
4. `delete` と入力して確認
5. **「削除」**をクリック

### コスト試算

```
cache.t4g.micro × 1ノード:
- 1時間: $0.018 = 約3円
- 1日: $0.432 = 約65円
- 1週間: $3.02 = 約450円
- 1ヶ月: $13.14 = 約2,000円
```

**重要**: 使わない時は必ず削除してください！

---

## クラスターモード vs サーバーレス

| 特徴 | クラスターキャッシュ | サーバーレス |
|------|-------------------|------------|
| **料金体系** | 時間課金 | データ量 + ECPU課金 |
| **最小コスト** | ~$13/月 | ~$60/月（常時1GB） |
| **スケーリング** | 手動 | 自動 |
| **学習目的** | ✅ 設定を学べる | △ 抽象化されすぎ |
| **本番推奨** | 中〜大規模 | 小規模・不定期 |
| **今回の選択** | ✅ これを使う | ✗ |

**今回はクラスターキャッシュで学習**することで、Redisの設定やキャッシュ設計を深く理解できます！

---

## 参考リンク

- [ElastiCache for Redis 公式ドキュメント](https://docs.aws.amazon.com/ja_jp/AmazonElastiCache/latest/red-ug/WhatIs.html)
- [料金表](https://aws.amazon.com/jp/elasticache/pricing/)
- [ベストプラクティス](https://docs.aws.amazon.com/ja_jp/AmazonElastiCache/latest/red-ug/BestPractices.html)
